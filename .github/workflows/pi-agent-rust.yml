name: pi-agent-rust

on:
  pull_request:
    paths:
      - 'Formula/pi-agent-rust.rb'
  push:
    paths:
      - 'Formula/pi-agent-rust.rb'
    branches:
      - main
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release (tag format: v0.1.0)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-C strip=symbols"

jobs:
  test-formula:
    name: Test Formula
    runs-on: macos-latest
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Build formula
        run: |
          brew install --formula Formula/pi-agent-rust.rb

      - name: Test installation
        run: |
          pir --version
          pir --help

  build:
    name: Build ${{ matrix.target }}
    if: github.event_name == 'workflow_dispatch' && inputs.release == true
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: pir-darwin-arm64
            binary: pir
          - target: x86_64-apple-darwin
            os: macos-13
            artifact: pir-darwin-amd64
            binary: pir
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: pir-linux-arm64
            binary: pir
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: pir-linux-amd64
            binary: pir

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          repository: Dicklesworthstone/pi_agent_rust

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact (Unix)
        run: |
          cd target/${{ matrix.target }}/release
          chmod +x pir
          tar czf ../../../${{ matrix.artifact }}.tar.gz pir
          cd ../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

  release:
    name: Create Release
    if: github.event_name == 'workflow_dispatch' && inputs.release == true
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum */*.tar.gz > SHA256SUMS

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${{ github.ref_name }}
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: pi-agent-rust ${{ github.ref_name }}
          body: |
            ## pi-agent-rust ${{ github.ref_name }}

            ### Binaries
            Download the appropriate binary for your platform:

            | Platform | Binary |
            |----------|--------|
            | macOS ARM64 (Apple Silicon) | `pir-darwin-arm64.tar.gz` |
            | macOS AMD64 (Intel) | `pir-darwin-amd64.tar.gz` |
            | Linux ARM64 | `pir-linux-arm64.tar.gz` |
            | Linux AMD64 | `pir-linux-amd64.tar.gz` |

            ### Installation
            ```bash
            # Download and extract
            curl -LO https://github.com/Dicklesworthstone/pi_agent_rust/releases/download/${{ github.ref_name }}/pir-<platform>.tar.gz
            tar xzf pir-<platform>.tar.gz

            # Install
            sudo mv pir /usr/local/bin/

            # Verify
            pir --version
            ```

            ### Checksums
            ```
            ${{ hashFiles('artifacts/SHA256SUMS') }}
            ```
          files: |
            artifacts/*/*.tar.gz
            artifacts/SHA256SUMS
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-formula:
    name: Update Formula
    if: github.event_name == 'workflow_dispatch' && inputs.release == true
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get checksums
        id: checksums
        run: |
          cd artifacts
          echo "darwin_arm64=$(sha256sum pir-darwin-arm64/pir-darwin-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "darwin_amd64=$(sha256sum pir-darwin-amd64/pir-darwin-amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum pir-linux-arm64/pir-linux-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_amd64=$(sha256sum pir-linux-amd64/pir-linux-amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Get version
        id: version
        run: |
          VERSION=${{ github.ref_name }}
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cat > Formula/pi-agent-rust.rb << 'EOF'
          class PiAgentRust < Formula
            desc "High-performance AI coding agent CLI written in Rust"
            homepage "https://github.com/Dicklesworthstone/pi_agent_rust"
            url "https://github.com/Dicklesworthstone/pi_agent_rust.git",
              branch: "main",
              revision: "0b29275dfad309dc1c4bd0714af188af8e5c4b53"
            version "${{ steps.version.outputs.VERSION }}"
            license "MIT"

          if Hardware::CPU.arm?
            url "https://github.com/Dicklesworthstone/pi_agent_rust/releases/download/v${{ steps.version.outputs.VERSION }}/pir-darwin-arm64.tar.gz"
            sha256 "${{ steps.checksums.outputs.darwin_arm64 }}"
          else
            url "https://github.com/Dicklesworthstone/pi_agent_rust/releases/download/v${{ steps.version.outputs.VERSION }}/pir-darwin-amd64.tar.gz"
            sha256 "${{ steps.checksums.outputs.darwin_amd64 }}"
          end

            depends_on "fd" => :recommended
            depends_on "ripgrep" => :recommended

            def install
              bin.install "pir"
            end

            test do
              assert_match "pi", shell_output("#{bin}/pir --version")
            end
          end
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "Update pi-agent-rust to v${{ steps.version.outputs.VERSION }}"
          body: |
            Automated update for pi-agent-rust ${{ steps.version.outputs.VERSION }}
          branch: "update/pi-agent-rust-${{ steps.version.outputs.VERSION }}"
          commit-message: "Update pi-agent-rust to v${{ steps.version.outputs.VERSION }}"
          labels: automated, dependencies
